---
title: "Programming concepts"
author: "Ryan Sheridan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Class-8}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "left"
)
library(tidyverse)
library(ggrepel)
library(pbda)
library(cowplot)
```

## Functions

### When should you write a function?
You should write a function if you've repeated a block of code more than once or twice.
```{r}
# An example: you want to rescale a numeric vector so all values are between 0 and 1
a <- rnorm(10)
a

rng <- range(a)
(a - rng[1]) / (rng[2] - rng[1])

# What if we want to repeat this on other vectors?
b <- rnorm(10)
b

c <- rnorm(10)
c

rng <- range(b)
new_b <- (b - rng[1]) / (rng[2] - rng[1])

rng <- range(c)
new_c <- (c - rng[1]) / (rng[2] - rng[1])
```

### Function structure
1. Pick a name
2. List the arguments
3. Add code to the body
```{r}
# A simple function to average two numbers
calc_mean <- function(x, y) {
  (x + y) / 2
}

calc_mean <- function(x, y) (x + y) / 2

calc_mean(2, 5)
```

*Write a function to rescale a numeric vector*
```{r}
rescale_nums <- function(x) {
  x_rng <- range(x)
  (x - x_rng[1]) / (x_rng[2] - x_rng[1])
}

rescale_nums(b)
rescale_nums(c)
```

### The function environment
- Code within a function is executed in an environment separate from the global environment
- The function environment consists of objects created within the function
- When an object is referenced within a function, R will first search the function environment
- If an object is not found within the function environment, R then searches the global environment
- An object within the function environment can have the same name as an object within the global environment, however when searching for an object, the function environment always takes precedence

INSERT DIAGRAM

*Can objects present in the global environment be referenced from within a function?*
```{r}
# Earlier we saved a numeric vector "a"
a

sum_nums <- function(x) {
  x + a
}

sum_nums(10)
```

*Can code executed within a function be used to modify an object present in the global environment?*
```{r}
sum_nums <- function(x) {
  a <- x + a
  a
}

sum_nums(10)

a
```

### A more relevant example
Lets create a scatter plot comparing growth rate vs expression for the gene YDL104C. We can use `facet_wrap()` to create a separate plot for each nutrient.
```{r, fig.width = 6, fig.height = 4}
brauer_gene_exp %>%
  filter(systematic_name == "YDL104C") %>%
  ggplot(aes(rate, expression, color = nutrient)) +
  geom_point(size = 1) +
  geom_smooth(method = "lm", se = F, size = 0.5) +
  facet_wrap(~ nutrient) +
  theme_cowplot()
```

What if you want to create this plot for multiple genes? *Write a function the takes a data.frame and gene name as inputs and creates scatter plots for each nutrient*
```{r, fig.width = 6, fig.height = 4}
plot_growth <- function(input, sys_name) {
  input %>%
    filter(systematic_name == sys_name) %>%
    ggplot(aes(rate, expression, color = nutrient)) +
    geom_point(size = 1) +
    geom_smooth(method = "lm", se = F, size = 0.5) +
    facet_wrap(~ nutrient) +
    theme_cowplot()
}

plot_growth(input = brauer_gene_exp, sys_name = "YDL104C")
```

*Modify our plotting function to add the gene name as the plot title and the molecular function as a subtitle*
```{r, fig.width = 6, fig.height = 4}
plot_growth <- function(input, sys_name) {
  gg_data <- input %>%
    filter(systematic_name == sys_name)
  
  plot_title <- gg_data$name[1]
  plot_sub <- gg_data$MF[1]
  
  gg_data %>%
    ggplot(aes(rate, expression, color = nutrient)) +
    geom_point(size = 1) +
    geom_smooth(method = "lm", se = F, size = 0.5) +
    labs(title = plot_title, subtitle = plot_sub) +
    facet_wrap(~ nutrient) +
    theme_cowplot()
}

brauer_gene_exp %>%
  plot_growth("YDL104C")
```

### Conditional statements
`if` statements allow you to execute code depending on defined conditions.
```
if (condition) {
  code executed when condition is TRUE
  
} else {
  code executed when condition is FALSE
}
```

R has a set of logical operators that can be used to write conditional statements

Operator | Description
:-------:|:-----------
<        | less than
<=       | less or equal
\>       | greater than
\>=      | greater or equal
==       | equal
!=       | not equal
!x       | not x
x \|\| y | x or y
x && y   | x and y
x %in% y | x is present in y

*Add an `if` statement to our plotting function to account for a missing gene name*
```{r, fig.width = 6, fig.height = 4}
plot_growth <- function(input, sys_name) {
  gg_data <- input %>%
    filter(systematic_name == sys_name)
  
  plot_title <- gg_data$name[1]
  plot_sub <- gg_data$MF[1]
  
  if (plot_title == "") {
    plot_title <- sys_name
  }
  
  gg_data %>%
    ggplot(aes(rate, expression, color = nutrient)) +
    geom_point(size = 1) +
    geom_smooth(method = "lm", se = F, size = 0.5) +
    labs(title = plot_title, subtitle = plot_sub) +
    facet_wrap(~ nutrient) +
    theme_cowplot()
}

brauer_gene_exp %>%
  plot_growth("YNL095C")
```

### Multiple conditions
```
if (condition_1) {
  executed when condition_1 is TRUE
  
} else if (condition_2) {
  executed when condition_2 if TRUE
  
} else {
  executed when condition_1 and condition_2 are FALSE
}


if (condition_1 && condition_2) {
  executed when condition_1 and condition_2 are TRUE
  
} else {
  executed when condition_1 or condition_2 are FALSE
}


if (condition_1 || condition_2) {
  executed when condition_1 or condition_2 are TRUE
  
} else {
  executed when condition_1 and condition_2 are FALSE
}
```

### Checking inputs
When writing functions it can be useful to check input values to make sure they are valid. Lets modify our plotting function to check that `sys_name` is a string.
```{r, fig.width = 6, fig.height = 4}
plot_growth <- function(input, sys_name) {
  
  if (!is.character(sys_name)) {
    stop("sys_name must be a string!")
  }
  
  gg_data <- input %>%
    filter(systematic_name == sys_name)
  
  plot_title <- gg_data$name[1]
  plot_sub <- gg_data$MF[1]
  
  if (plot_title == "") {
    plot_title <- sys_name
  }
  
  gg_data %>%
    ggplot(aes(rate, expression, color = nutrient)) +
    geom_point(size = 1) +
    geom_smooth(method = "lm", se = F, size = 0.5) +
    labs(title = plot_title, subtitle = plot_sub) +
    facet_wrap(~ nutrient) +
    theme_cowplot()
}

brauer_gene_exp %>%
  plot_growth("YNL095C")
```

*Modify our plotting function to check that `sys_name` is present in the input. Hint: use the `%in%` operator*
```{r, fig.width = 6, fig.height = 4}
plot_growth <- function(input, sys_name) {
  
  if (!is.character(sys_name)) {
    stop("sys_name must be a string!")
  }
  
  if (!sys_name %in% input$systematic_name) {
    stop("sys_name not found in input data!")
  }
  
  gg_data <- input %>%
    filter(systematic_name == sys_name)
  
  plot_title <- gg_data$name[1]
  plot_sub <- gg_data$MF[1]
  
  if (plot_title == "") {
    plot_title <- sys_name
  }
  
  gg_data %>%
    ggplot(aes(rate, expression, color = nutrient)) +
    geom_point(size = 1) +
    geom_smooth(method = "lm", se = F, size = 0.5) +
    labs(title = plot_title, subtitle = plot_sub) +
    facet_wrap(~ nutrient) +
    theme_cowplot()
}

brauer_gene_exp %>%
  plot_growth("YNL095C")
```

### Passing arguments with dots (...)
dots allow a function to take an arbitrary number of arguments, which can then be passed to other functions. Lets first try this using our simple `rescale_nums()` function. 
```{r}
rescale_nums <- function(x, ...) {
  x_rng <- range(x, ...)
  (x - x_rng[1]) / (x_rng[2] - x_rng[1])
}

rescale_nums(a)

a[1] <- NA

rescale_nums(a, na.rm = T)
```

*Modify our plotting function to pass arguments through dots to ggplot*
```{r, fig.width = 6, fig.height = 4}
plot_growth <- function(input, sys_name, ...) {
  
  if (!is.character(sys_name)) {
    stop("sys_name must be a string!")
  }
  
  if (!sys_name %in% input$systematic_name) {
    stop("sys_name not found in input data!")
  }
  
  gg_data <- input %>%
    filter(systematic_name == sys_name)
  
  plot_title <- gg_data$name[1]
  plot_sub <- gg_data$MF[1]
  
  if (plot_title == "") {
    plot_title <- sys_name
  }
  
  gg_data %>%
    ggplot(aes(rate, expression, color = nutrient)) +
    geom_point(...) +
    geom_smooth(method = "lm", se = F, size = 0.5) +
    labs(title = plot_title, subtitle = plot_sub) +
    facet_wrap(~ nutrient) +
    theme_cowplot()
}

brauer_gene_exp %>%
  plot_growth(
    sys_name = "YNL095C",
    size  = 3,
    shape = 5,
    alpha = 0.5
  )
```












